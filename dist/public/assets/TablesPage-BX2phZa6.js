import{i as re,am as ve,a4 as p,r as v,b as E,x as ce,T as f,U as n,Y as s,a8 as m,V as u,a3 as P,aa as S,a9 as o,w as I,an as U,ao as fe,W as i,Z as N,$ as y,a6 as T,ap as pe,aq as A,a0 as be,ar as F,X as me,a1 as O,a2 as R,A as ye}from"./index-GPq7ISSp.js";import{Q as ge,a as ke,b as $}from"./QList-6HEYVZ1D.js";import{Q as _e}from"./browser-BtZzEF0O.js";function Ce(){return re(ve)}const xe={class:"tables-page"},we={class:"tabs"},Te=["onClick"],he={class:"table-grid"},qe=["onClick"],Qe={class:"table-id"},Ve={class:"status-text"},Ie={key:0,class:"status-text"},Ne=["onClick"],Oe={key:0,class:"add-table-form"},$e={key:0,class:"error"},Me=["value"],Ee=["disabled"],Pe=["disabled"],Se=["disabled"],Ue={class:"text-right",style:{"margin-top":"12px"}},Be={class:"modal-actions",style:{display:"flex","justify-content":"space-between","margin-top":"16px"}},De={key:0,class:"modal-actions",style:{display:"flex","justify-content":"space-between","margin-top":"16px"}},je={class:"text-h6"},Ae={class:"text-subtitle2",style:{"text-align":"left",width:"100%"}},Ge={__name:"TablesPage",setup(Fe){const k=Ce(),_=p.tables,z=p.tablesPassword,B=v(!1),M=v(null),d=v(null),t=v(null),r=v(!1),h=v("全部"),g=v(!1),q=v(!1),Q=v(""),V=v(""),L=E(()=>!t.value||!t.value.order?"0.00":t.value.order.reduce((a,e)=>a+e.price*e.quantity,0).toFixed(2)),G=E(()=>h.value==="全部"?_.value:_.value.filter(a=>a.status===h.value)),K=E({get(){return t.value?z.value.find(e=>e.id===t.value.id)?.password??0:0},set(a){if(!t.value)return;let e=Number(a);(isNaN(e)||e<0)&&(e=0),e>999&&(e=999),p.updateTablePassword(t.value.id,e)}});function W(){q.value=!0,b.value=!1,p.getOrders(d.value.id)}function D(a){if(!t.value?.peopleType)return;let e=t.value.peopleType.adults||0,l=t.value.peopleType.childres||0;a==="adults"&&(isNaN(e)||e<0)&&(e=0),a==="childres"&&(isNaN(l)||l<0)&&(l=0);let c=e+l;t.value.people=c;const x=_.value.find(w=>w.id===t.value.id);x&&(x.people=c)}function X(a){return a.order.reduce((e,l)=>e+l.price*l.quantity,0).toFixed(2)}ce(d,async a=>{a?(t.value={...a},r.value=a.status==="空闲",await ye(),Y()):(B.value=!1,r.value=!1)});function j(){d.value=null,t.value=null,r.value=!1}const Y=()=>{if(!t.value||!M.value)return;const a=window.global_qr_addr+t.value.id;console.log("QRCode data: ",a),_e.toCanvas(M.value,a,{width:150},e=>{e?console.error("二维码生成失败",e):B.value=!0})};function Z(){r.value=!0}function H(){r.value=!1,t.value&&k.dialog({title:"确认清理",message:`确认清理桌号 ${t.value.id} 吗？这将清除当前人数并设为空闲。`,cancel:!0,persistent:!0}).onOk(()=>{p.socket.emit("clean_table",d.value.id,a=>{a.success?(_.value=a.tables,d.value=null,t.value=null):k.dialog({title:"错误",message:a.message})})})}function J(){const a=parseInt(V.value);p.socket.emit("add_table",{id:a,people:0,status:"空闲"},e=>{e.success?(V.value="",Q.value=""):Q.value=e.message||"添加失败"})}function ee(a){k.dialog({title:"确认删除",message:`确定要删除桌号 ${a} 吗？此操作不可恢复。`,cancel:!0,persistent:!0}).onOk(()=>{p.socket.emit("remove_table",a,e=>{e.success?(_.value=e.tables,d.value?.id===a&&(d.value=null,t.value=null)):k.dialog({title:"错误",message:e.message})})})}function le(){r.value=!1,d.value=null,t.value=null}function te(a){switch(a){case"用餐中":return"occupied";case"已预订":return"reserved";case"已支付":return"paid";case"空闲":default:return"available"}}function ae(a){d.value=a,t.value={...a}}function se(){g.value=!g.value,g.value||(d.value=null)}function ue(){r.value=!1;const a=t.value;a.status==="空闲"&&(a.people=0);const e=t.value?.id;e&&p.updateTablePassword(e,K.value),p.socket.emit("update_table",a,l=>{l.success?(d.value=null,t.value=null):k.dialog({title:"错误",message:l.message,ok:"明白了"})})}const b=v(!1),C=v([]);function ne(){b.value=!b.value}function ie(a){if(console.log("dish: ",a),!t.value)return;const e=t.value.order,l=e.findIndex(w=>w.dishid===a.dishid);if(l===-1)return;const c=e[l];c.quantity-=1;const x=C.value.find(w=>w.dishid===c.dishid);x?x.quantity+=1:C.value.push({dishid:c.dishid,quantity:1}),c.quantity<=0&&e.splice(l,1)}function oe(){t.value&&(console.log("deleted tables: ",C.value),console.log("editedTable: ",t.value),p.deleteOrders(t.value.id,C.value),b.value=!1)}function de(){q.value=!1,b.value=!1,C.value=[]}return(a,e)=>(n(),f("div",xe,[s("div",we,[(n(),f(P,null,S(["全部","空闲","用餐中","已预订","已支付"],l=>s("button",{key:l,class:F({active:h.value===l}),onClick:c=>h.value=l},o(l),11,Te)),64))]),s("button",{onClick:se,class:"edit-mode-btn"},o(g.value?"退出编辑模式":"进入编辑模式"),1),s("div",he,[(n(!0),f(P,null,S(G.value,l=>(n(),f("div",{key:l.id,class:F(["table-card",te(l.status)]),onClick:c=>!g.value&&ae(l)},[s("div",Qe,"桌号 "+o(l.id),1),s("div",Ve,o(l.status),1),s("div",null,"当前人数："+o(l.people),1),l.order.length>0?(n(),f("div",Ie," 消费：€"+o(X(l)),1)):m("",!0),g.value?(n(),f("button",{key:1,class:"delete-btn",onClick:A(c=>ee(l.id),["stop"]),title:"删除桌子"}," × ",8,Ne)):m("",!0)],10,qe))),128))]),g.value?m("",!0):(n(),f("div",Oe,[I(s("input",{"onUpdate:modelValue":e[0]||(e[0]=l=>V.value=l),type:"number",placeholder:"桌号"},null,512),[[U,V.value]]),s("button",{onClick:J,class:"add-table-btn"},"添加桌子"),Q.value?(n(),f("p",$e,o(Q.value),1)):m("",!0)])),d.value?(n(),f("div",{key:1,class:"modal",onClick:j},[s("div",{class:"modal-content",onClick:e[6]||(e[6]=A(()=>{},["stop"]))},[s("button",{class:"close-btn",onClick:j,"aria-label":"关闭弹窗"},"×"),s("h3",null,"桌号 "+o(t.value.id),1),e[12]||(e[12]=s("label",null,"当前人数：",-1)),s("input",{type:"number",value:t.value.people,disabled:""},null,8,Me),s("div",null,[e[9]||(e[9]=s("label",null,"成人：",-1)),I(s("input",{type:"number","onUpdate:modelValue":e[1]||(e[1]=l=>t.value.peopleType.adults=l),min:"0",disabled:!r.value,onInput:e[2]||(e[2]=l=>D("adults"))},null,40,Ee),[[U,t.value.peopleType.adults,void 0,{number:!0}]])]),s("div",null,[e[10]||(e[10]=s("label",null,"儿童：",-1)),I(s("input",{type:"number","onUpdate:modelValue":e[3]||(e[3]=l=>t.value.peopleType.childres=l),min:"0",disabled:!r.value,onInput:e[4]||(e[4]=l=>D("childres"))},null,40,Pe),[[U,t.value.peopleType.childres,void 0,{number:!0}]])]),e[13]||(e[13]=s("label",null,"状态：",-1)),I(s("select",{"onUpdate:modelValue":e[5]||(e[5]=l=>t.value.status=l),disabled:!r.value},e[11]||(e[11]=[s("option",{value:"空闲"},"空闲",-1),s("option",{value:"用餐中"},"用餐中",-1),s("option",{value:"已预订"},"已预订",-1),s("option",{value:"已支付"},"已支付",-1)]),8,Se),[[fe,t.value.status]]),u(N,{class:"flex flex-center"},{default:i(()=>[s("canvas",{ref_key:"qrCanvas",ref:M,style:{"margin-top":"8px"}},null,512)]),_:1}),s("div",Ue,[u(y,{label:"查看订单",color:"secondary",onClick:W})]),s("div",Be,[u(y,{label:"一键清理",color:"negative",flat:"",onClick:H,style:pe(t.value.people>0||t.value.status!=="空闲"?"visibility: visible;":"visibility: hidden;")},null,8,["style"]),r.value?(n(),f("div",De,[u(y,{label:"保存",color:"primary",onClick:ue,class:"q-mr-sm"}),u(y,{label:"取消",color:"grey",onClick:le})])):m("",!0),r.value?m("",!0):(n(),T(y,{key:1,label:"编辑",color:"primary",onClick:Z}))])])])):m("",!0),u(be,{modelValue:q.value,"onUpdate:modelValue":e[8]||(e[8]=l=>q.value=l)},{default:i(()=>[u(me,{style:{"min-width":"500px"}},{default:i(()=>[u(N,null,{default:i(()=>[s("div",je,"桌号 "+o(t.value.id)+" 的订单",1)]),_:1}),t.value.order.length>0?(n(),T(N,{key:0},{default:i(()=>[u(ge,{bordered:""},{default:i(()=>[(n(!0),f(P,null,S(t.value.order,l=>(n(),T(ke,{key:l.name},{default:i(()=>[u($,null,{default:i(()=>[O(o(l.name),1)]),_:2},1024),u($,null,{default:i(()=>[O("数量: "+o(l.quantity),1)]),_:2},1024),u($,null,{default:i(()=>[O("单价: €"+o(l.price.toFixed(2)),1)]),_:2},1024),b.value?(n(),T($,{key:0,side:""},{default:i(()=>[u(y,{dense:"",flat:"",icon:"close",color:"negative",onClick:c=>ie(l)},null,8,["onClick"])]),_:2},1024)):m("",!0)]),_:2},1024))),128))]),_:1})]),_:1})):(n(),T(N,{key:1},{default:i(()=>e[14]||(e[14]=[O(" 暂无订单。 ")])),_:1,__:[14]})),u(R,{class:"q-gutter-sm",style:{padding:"8px 16px"}},{default:i(()=>[s("div",Ae," 消费：€"+o(L.value),1)]),_:1}),u(R,{class:"q-gutter-sm",style:{display:"flex","justify-content":"space-between",padding:"8px 16px"}},{default:i(()=>[u(y,{flat:"",label:"关闭",color:"primary",onClick:de,dense:""}),u(y,{label:b.value?"保存":"编辑",color:"primary",onClick:e[7]||(e[7]=l=>b.value?oe():ne()),dense:""},null,8,["label"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}};export{Ge as default};
