import{i as J,aY as ee,r as d,Z as k,b as B,x as le,T as r,U as u,$ as s,a8 as p,V as n,Y as P,az as $,a9 as o,w as g,aZ as T,a_ as ae,W as v,a0 as V,a2 as y,a6 as I,a$ as te,b0 as j,X as se,b1 as D,_ as ue,a3 as h,a4 as ne,A as oe}from"./index-CL004plG.js";import{Q as ie,a as de,b as M}from"./QList-ByM7IuzF.js";import{C as re}from"./ClosePopup-D3VteD1V.js";import{Q as ve}from"./browser-BtZzEF0O.js";function ce(){return J(ee)}const pe={class:"tables-page"},me={class:"tabs"},fe=["onClick"],be={class:"table-grid"},ge=["onClick"],ye={class:"table-id"},_e={class:"status-text"},ke={key:0,class:"status-text"},xe=["onClick"],Ce={key:0,class:"add-table-form"},we={key:0,class:"error"},Qe=["max","disabled"],Te=["disabled"],Ve=["disabled"],Ie={class:"text-right",style:{"margin-top":"12px"}},he={class:"modal-actions",style:{display:"flex","justify-content":"space-between","margin-top":"16px"}},qe={key:0,class:"modal-actions",style:{display:"flex","justify-content":"space-between","margin-top":"16px"}},Ne={class:"text-h6"},Pe={key:0,class:"text-subtitle2"},Be={__name:"TablesPage",setup($e){const f=ce(),b=d(k.tables),U=d(!1),q=d(null),x=d(""),C=d(4),_=d(""),m=d(!1),c=d(null),t=d(null),i=d(!1),w=d("全部"),N=d(!1),F=B(()=>w.value==="全部"?b.value:b.value.filter(l=>l.status===w.value));function E(l){return B(()=>l.order.reduce((e,a)=>e+a.price*a.quantity,0).toFixed(2))}le(c,async l=>{l?(t.value={...l},i.value=l.status==="空闲",await oe(),z()):(U.value=!1,i.value=!1)});function S(){c.value=null,t.value=null,i.value=!1}const z=()=>{if(!t.value||!q.value)return;const l=window.global_qr_addr+t.value.id;console.log("QRCode data: ",l),ve.toCanvas(q.value,l,{width:150},e=>{e?console.error("二维码生成失败",e):U.value=!0})};function A(){i.value=!0}function O(l){let e=l.target.value.replace(/[^\d]/g,"");e===""&&(e="0"),l.target.value=e,t.value.people=parseInt(e)}function R(l){let e=l.target.value.replace(/[^\d]/g,"");(e===""||e==="0")&&(e="1"),l.target.value=e,t.value.maxPeople=parseInt(e)}function L(){i.value=!1,t.value&&f.dialog({title:"确认清理",message:`确认清理桌号 ${t.value.id} 吗？这将清除当前人数并设为空闲。`,cancel:!0,persistent:!0}).onOk(()=>{k.socket.emit("clean_table",c.value.id,l=>{l.success?(b.value=l.tables,c.value=null,t.value=null):f.dialog({title:"错误",message:l.message})})})}function Y(){const l=parseInt(x.value),e=parseInt(C.value);if(isNaN(l)||isNaN(e)||e<1){_.value="请输入有效的桌号和最大人数";return}k.socket.emit("add_table",{id:l,people:0,maxPeople:e,status:"空闲"},a=>{a.success?(b.value=a.tables,x.value="",C.value=4,_.value=""):_.value=a.message||"添加失败"})}function Z(l){f.dialog({title:"确认删除",message:`确定要删除桌号 ${l} 吗？此操作不可恢复。`,cancel:!0,persistent:!0}).onOk(()=>{k.socket.emit("remove_table",l,e=>{e.success?(b.value=e.tables,c.value?.id===l&&(c.value=null,t.value=null)):f.dialog({title:"错误",message:e.message})})})}function G(){i.value=!1,c.value=null,t.value=null}function K(l){switch(l){case"用餐中":return"occupied";case"已预订":return"reserved";case"已支付":return"paid";case"空闲":default:return"available"}}function W(l){c.value=l,t.value={...l}}function X(){m.value=!m.value,m.value||(c.value=null)}function H(){i.value=!1;const l=t.value;if(l.people>l.maxPeople){f.dialog({title:"人数错误",message:"当前人数不能超过最大人数。"});return}l.status==="空闲"&&(l.people=0),k.socket.emit("update_table",l,e=>{e.success?(b.value=e.tables,c.value=null,t.value=null):f.dialog({title:"错误",message:e.message,ok:"明白了"})})}return(l,e)=>(u(),r("div",pe,[s("div",me,[(u(),r(P,null,$(["全部","空闲","用餐中","已预订","已支付"],a=>s("button",{key:a,class:D({active:w.value===a}),onClick:Q=>w.value=a},o(a),11,fe)),64))]),s("button",{onClick:X,class:"edit-mode-btn"},o(m.value?"退出编辑模式":"进入编辑模式"),1),s("div",be,[(u(!0),r(P,null,$(F.value,a=>(u(),r("div",{key:a.id,class:D(["table-card",K(a.status)]),onClick:Q=>!m.value&&W(a)},[s("div",ye,"桌号 "+o(a.id),1),s("div",null,o(a.people)+" / "+o(a.maxPeople)+" 人",1),s("div",_e,o(a.status),1),a.order.length>0?(u(),r("div",ke," 消费：€"+o(E(a).value),1)):p("",!0),m.value?(u(),r("button",{key:1,class:"delete-btn",onClick:j(Q=>Z(a.id),["stop"]),title:"删除桌子"}," × ",8,xe)):p("",!0)],10,ge))),128))]),m.value?p("",!0):(u(),r("div",Ce,[g(s("input",{"onUpdate:modelValue":e[0]||(e[0]=a=>x.value=a),type:"number",placeholder:"桌号"},null,512),[[T,x.value]]),g(s("input",{"onUpdate:modelValue":e[1]||(e[1]=a=>C.value=a),type:"number",min:"1",placeholder:"最大人数"},null,512),[[T,C.value,void 0,{number:!0}]]),s("button",{onClick:Y,class:"add-table-btn"},"添加桌子"),_.value?(u(),r("p",we,o(_.value),1)):p("",!0)])),c.value?(u(),r("div",{key:1,class:"modal",onClick:S},[s("div",{class:"modal-content",onClick:e[6]||(e[6]=j(()=>{},["stop"]))},[s("button",{class:"close-btn",onClick:S,"aria-label":"关闭弹窗"},"×"),s("h3",null,"桌号 "+o(t.value.id),1),e[9]||(e[9]=s("label",null,"当前人数：",-1)),g(s("input",{type:"number","onUpdate:modelValue":e[2]||(e[2]=a=>t.value.people=a),max:t.value.maxPeople,min:"1",onInput:O,disabled:t.value.status==="空闲"||!i.value},null,40,Qe),[[T,t.value.people,void 0,{number:!0}]]),e[10]||(e[10]=s("label",null,"最大人数：",-1)),g(s("input",{type:"number","onUpdate:modelValue":e[3]||(e[3]=a=>t.value.maxPeople=a),min:"1",onInput:R,disabled:!i.value},null,40,Te),[[T,t.value.maxPeople,void 0,{number:!0}]]),e[11]||(e[11]=s("label",null,"状态：",-1)),g(s("select",{"onUpdate:modelValue":e[4]||(e[4]=a=>t.value.status=a),disabled:!i.value},e[8]||(e[8]=[s("option",{value:"空闲"},"空闲",-1),s("option",{value:"用餐中"},"用餐中",-1),s("option",{value:"已预订"},"已预订",-1),s("option",{value:"已支付"},"已支付",-1)]),8,Ve),[[ae,t.value.status]]),n(V,{class:"flex flex-center"},{default:v(()=>[s("canvas",{ref_key:"qrCanvas",ref:q,style:{"margin-top":"8px"}},null,512)]),_:1}),s("div",Ie,[n(y,{label:"查看订单",color:"secondary",onClick:e[5]||(e[5]=a=>N.value=!0)})]),s("div",he,[n(y,{label:"一键清理",color:"negative",flat:"",onClick:L,style:te(t.value.people>0||t.value.status!=="空闲"?"visibility: visible;":"visibility: hidden;")},null,8,["style"]),i.value?(u(),r("div",qe,[n(y,{label:"保存",color:"primary",onClick:H,class:"q-mr-sm"}),n(y,{label:"取消",color:"grey",onClick:G})])):p("",!0),i.value?p("",!0):(u(),I(y,{key:1,label:"编辑",color:"primary",onClick:A}))])])])):p("",!0),n(se,{modelValue:N.value,"onUpdate:modelValue":e[7]||(e[7]=a=>N.value=a)},{default:v(()=>[n(ue,{style:{"min-width":"400px"}},{default:v(()=>[n(V,null,{default:v(()=>[s("div",Ne,"桌号 "+o(t.value.id)+" 的订单",1)]),_:1}),t.value.order.length>0?(u(),I(V,{key:0},{default:v(()=>[n(ie,{bordered:""},{default:v(()=>[(u(!0),r(P,null,$(t.value.order,(a,Q)=>(u(),I(de,{key:Q},{default:v(()=>[n(M,null,{default:v(()=>[h(o(a.name),1)]),_:2},1024),n(M,null,{default:v(()=>[h("数量: "+o(a.quantity),1)]),_:2},1024),n(M,null,{default:v(()=>[h("单价: €"+o(a.price.toFixed(2)),1)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})):(u(),I(V,{key:1},{default:v(()=>e[12]||(e[12]=[h(" 暂无订单。 ")])),_:1,__:[12]})),n(ne,{class:"q-gutter-sm justify-between items-center"},{default:v(()=>[t.value.order.length>0?(u(),r("div",Pe," 消费：€"+o(E(t.value).value),1)):p("",!0),g(n(y,{flat:"",label:"关闭",color:"primary"},null,512),[[re]])]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}};export{Be as default};
